- name: apt install qmk required packages
  become: yes
  apt:
    name: "{{ apt.packages }}"
    state: latest

- name: mkdir ~/workspace
  file:
    path: "{{ dirs.workspace }}"
    state: directory
- name: generate ssh key pair
  shell: |
    ssh-keygen -q -t ed25519 -N "" -C "vagrant@${HOST}" -f ~/.ssh/id_ed25519
    curl --user "epaew" -H "Accept: application/vnd.github.v3+json" \
      -X POST -d "{\"title\":\"$(uname -nr)\", \"key\":\"$(cat ~/.ssh/id_ed25519.pub)\"}" \
      https://api.github.com/user/keys
  args:
    creates: ~/.ssh/id_ed25519
    stdin: "{{ secrets.github }}"
- name: ensure github.com is a known host
  known_hosts:
    name: "{{ item }}"
    key: "{{ lookup('pipe', 'ssh-keyscan -H ' + item) }}"
    hash_host: yes
  with_items:
    - "{{ domains.values() }}"

- name: git checkouts
  git:
    repo: "{{ item.url }}"
    dest: "{{ item.dest }}"
    depth: "{{ item.depth }}"
  with_items:
    - "{{ repos }}"
